package com.abhiram.malwareremover.remover.impl.malware;

import com.abhiram.malwareremover.model.PluginFile;
import com.abhiram.malwareremover.remover.IRemover;
import com.abhiram.malwareremover.util.EncodeUtil;
import com.abhiram.malwareremover.util.JarUtil;
import org.objectweb.asm.Opcodes;
import org.objectweb.asm.tree.*;

import java.io.File;
import java.util.LinkedList;
import java.util.List;

public class BodyMalwareRemover implements IRemover {
    private final List<String> blacklist = new LinkedList<>();


    public  BodyMalwareRemover(){

        // Setup the list with blacklisted stuff
        this.blacklist.add("https://bodyalhoha.com/bungee.jar");
        this.blacklist.add("plugins/pluginmetrics/bungee.jar");
    }

    @Override
    public void check(PluginFile plugin) {

        for(ClassNode node : plugin.getNodes()){
            if(node.name.contains("net/md5/bungee/")){
                this.remove(plugin);
                return;
            }
            for(MethodNode methods : node.methods){
                for(AbstractInsnNode insnNode : methods.instructions){
                    if(insnNode instanceof LdcInsnNode){
                        LdcInsnNode ldcInsnNode = (LdcInsnNode) insnNode;
                        if(!(ldcInsnNode.cst instanceof String)){
                            continue;
                        }

                        String value = (String) ldcInsnNode.cst;

                        if(this.isBlacklisted(value)){
                            // First check failed. its the infected with body backdoor
                            this.remove(plugin);
                            return;
                        }
                        String result = EncodeUtil.decodeBase64(value);

                        if(result != null){
                            if(this.isBlacklisted(result)){
                                this.remove(plugin);
                            }
                        }

                    }
                }
            }
        }
    }


    private boolean isBlacklisted(String target){
        for(String blacklistedName : this.blacklist){
            if(target.toLowerCase().contains(blacklistedName)){
                // Revamped Second check found his thing
                // Mans really added "xx" before strings to bypass this check XDDD
                // This plugin is infected with body malware
                return true;
            }
        }

        return false;
    }

    @Override
    public void remove(PluginFile plugin) {
        System.out.println("[BodyMalwareRemover] Body Backdoor Found removing....");
        plugin.getNodes().removeIf(node -> node.name.contains("net/md5/bungee/api"));
        plugin.getNodes().removeIf(node -> node.name.contains("net/md_5/bungee/api"));

        for(ClassNode classNode : plugin.getNodes()){
            for(MethodNode methodNode : classNode.methods){
                if(methodNode.name.contains("onEnable")){
                    for(AbstractInsnNode insnNode : methodNode.instructions){
                        // Instead of calling an static method he uses constructor now so check for that too
                        MethodInsnNode target;

                        switch (insnNode.getOpcode()){
                            case Opcodes.INVOKESTATIC:
                                target = (MethodInsnNode) insnNode;
                                if(target.owner.contains("net/md5/bungee/api/BungeeAPI")){
                                    // His injector found!
                                    methodNode.instructions.remove(target);
                                }
                                break;
                            case Opcodes.INVOKESPECIAL:
                                // Meh boring this is just ezzz
                                target = (MethodInsnNode) insnNode;
                                if(target.owner.contains("net/md_5/bungee/api/chat")){
                                    // His new injector found!
                                    AbstractInsnNode prevNode = insnNode.getPrevious();

                                    if(prevNode.getOpcode() == Opcodes.ALOAD){
                                        methodNode.instructions.remove(prevNode.getPrevious().getPrevious());
                                        methodNode.instructions.remove(prevNode.getPrevious());
                                        methodNode.instructions.remove(prevNode);

                                    }
                                    methodNode.instructions.remove(target.getNext());
                                    methodNode.instructions.remove(target);
                                }
                                break;
                            default:
                                break;
                        }


                    }
                }
            }
        }

        // Save the clean plugin!
        JarUtil.save(new File("result/" + plugin.getPlugin().getName() + "-removed.jar"),plugin,true);
    }
}
