package com.abhiram.malwareremover.remover.impl.malware;

import com.abhiram.malwareremover.model.PluginFile;
import com.abhiram.malwareremover.remover.IRemover;
import com.abhiram.malwareremover.util.EncodeUtil;
import com.abhiram.malwareremover.util.JarUtil;
import org.apache.commons.codec.binary.Base64;
import org.objectweb.asm.tree.*;

import java.io.File;
import java.nio.charset.StandardCharsets;

public class QlutchBackdoorRemover implements IRemover {

    @Override
    public void check(PluginFile plugin) {
        boolean removed = false;

        for(ClassNode classNode : plugin.getNodes()){
            for(MethodNode methodNode : classNode.methods){
                for(AbstractInsnNode insn : methodNode.instructions){
                    if(insn instanceof LdcInsnNode){
                        LdcInsnNode url = (LdcInsnNode) insn;
                        if(!(url.cst instanceof String)){
                            continue;
                        }

                        String result = EncodeUtil.decodeBase64((String) url.cst);
                        if(result != null){
                            if(!result.contains("https://minecraftforceop.com/")){
                                continue;
                            }
                            // We found qlutch injection now we need to fuck noot's injection
                            url.cst = Base64.encodeBase64("https://nootisaskidlocalhost.localhost/getrekt".getBytes(StandardCharsets.UTF_8));

                            //System.out.println(result);
                            removed = true;
                        }
                    }
                }
            }
        }

        if(removed){
            JarUtil.save(new File("result/" + plugin.getPlugin().getName() + "-removed.jar"),plugin,true);
        }
    }

    @Override
    public void remove(PluginFile plugin) {

    }
}
